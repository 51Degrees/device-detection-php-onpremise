<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees Device Detection On-Premise PHP: 51Degrees PHP Device Detection On-Premise</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="testedversionsgrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="../../documentation/4.4/index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees Device Detection On-Premise PHP
   &#160;<span id="projectnumber">4.4</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
   <div id="projectbrief">Device detection services for 51Degrees Pipeline</div>
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_runner_work_device-detection-php-onpremise_device-detection-php-onpremise_common_device-detection-php-onpremise_readme.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="PageDoc"><div class="g-docs__header">
<div class="c-breadcrumb">
  <ul class="c-breadcrumb">
<li class="c-breadcrumb__item"><a class="c-breadcrumb__link" href="md__home_runner_work_device-detection-php-onpremise_device-detection-php-onpremise_common_device-detection-php-onpremise_readme.html">51Degrees PHP Device Detection On-Premise</a></li>  </ul>
</div>
<h2 class="g-docs__page-title">51Degrees PHP Device Detection On-Premise </h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<section class="g-docs__section"><img src="https://51degrees.com/DesktopModules/FiftyOne/Distributor/Logo.ashx?utm_source=github&utm_medium=repository&utm_content=readme_main&utm_campaign=php-open-source" alt="51Degrees" title="Data rewards the curious" class="inline"/>
 <b>PHP Pipeline API</b></p>
<p><a href="https://51degrees.com/device-detection-php/index.html?utm_source=github&amp;utm_medium=repository&amp;utm_content=documentation&amp;utm_campaign=php-open-source" title="developer documentation">Developer Documentation</a></p>
<h2>Introduction</h2>
<p>This project contains the on-premise version of 51Degrees Device Detection for the Pipeline API.</p>
<p>When using on-premise device detection engines in the PHP pipeline, the appropriate extensions will need to be installed.</p>
<h2>Dependencies</h2>
<p>For runtime dependencies, see our <a href="http://51degrees.com/documentation/_info__dependencies.html">dependencies</a> page. The <a href="https://51degrees.com/documentation/_info__tested_versions.html">tested versions</a> page shows the PHP versions that we currently test against. The software may run fine against other versions, but additional caution should be applied.</p>
<h3>Data file</h3>
<p>In order to perform device detection on-premise, you will need to use a 51Degrees data file. This repository includes a free, 'lite' file in the 'device-detection-data' sub-module, which has a significantly reduced set of properties. To obtain a file with a more complete set of device properties see the <a href="https://51degrees.com/pricing">51Degrees website</a>. If you want to use the lite file, you will need to install <a href="https://git-lfs.github.com/">GitLFS</a>:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">sudo apt-get install git-lfs</div><div class="c-code__line">git lfs install</div></div><p>Then, navigate to 'on-premise/device-detection-cxx/device-detection-data' and execute:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">git lfs pull</div></div><h2>Install</h2>
<p>Device detection on-premise uses a native binary. (i.e. compiled from C code to target a specific platform/architecture). This section explains how to build the binary and how to build the PHP extension that uses it.</p>
<h3>Pre-requisites</h3>
<ul>
<li>php &amp; php-dev<ul>
<li><code>sudo apt-get install php php-dev</code></li>
</ul>
</li>
<li>Install C build tools:<ul>
<li>Windows:<ul>
<li>You will need either Visual Studio 2019 or the <a href="https://visualstudio.microsoft.com/visual-cpp-build-tools/">C++ Build Tools</a> installed.<ul>
<li>Minimum platform toolset version is <code>v142</code></li>
<li>Minimum Windows SDK version is <code>10.0.18362.0</code></li>
</ul>
</li>
</ul>
</li>
<li>Linux/MacOS:<ul>
<li><code>sudo apt-get install g++ make libatomic1</code></li>
</ul>
</li>
</ul>
</li>
<li>Pull git submodules:<ul>
<li><code>git submodule update --init --recursive</code></li>
</ul>
</li>
</ul>
<h3>Build Steps</h3>
<p>Now, we can create the extension. Navigate to the <code>on-premise</code> directory and install it with:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">phpize</div><div class="c-code__line">./configure</div><div class="c-code__line">make</div><div class="c-code__line">sudo make install</div></div><p>The Hash engine extension will then be installed into the PHP extensions directory and can then be added to the active php.ini file.</p>
<h3>Regenerating swig wrapper files.</h3>
<p><b>Note</b> - this step should not normally need to be performed outside 51Degrees. We include the instructions here for the rare case where it is necessary.</p>
<p>If the SWIG wrapper files need to be regenerated due to new code in the 'device-detection-cxx' submodule, add <code>SWIG=1</code> to the <code>./configure</code> step. Note that for backwards compatibility with PHP 5, SWIG 3.0.12 is used for the pregenerated files in this repository. Newer versions of SWIG can be used, provided the extension is being built only for PHP 7.</p>
<p>Currently, The generation of SWIG wrapper files is using a specific revision of SWIG and is done using the following steps:</p>
<p>Checkout and install SWIG:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">git clone https://github.com/swig/swig.git</div><div class="c-code__line">cd swig</div><div class="c-code__line">git checkout fd96627b2fc65353c03b160efd60fdce864d386c</div><div class="c-code__line">./autogen.sh</div><div class="c-code__line">./configure</div><div class="c-code__line">make</div><div class="c-code__line">sudo make install</div></div><p>Generate wrapper files:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">$:~/device-detection-php-onpremise</div><div class="c-code__line">cd on-premise</div><div class="c-code__line">phpize</div><div class="c-code__line">swig -v -c++ -php7 -module FiftyOneDegreesHashEngine -outdir src/php8 -o src/php8/hash_wrap.cxx hash-php.i</div></div><h3>Windows</h3>
<p>Although building extensions on Windows is possible, we recommend using the <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">Windows Subsystem for Linux</a> and following the instructions for Linux above.</p>
<h2>Configuration</h2>
<p>The minimum configuration needed for the extensions is to add it to the active php.ini file, and set the data file. For example:</p>
<pre>
<code>extension=/usr/lib/php/<span style="background-color: #FFFF00">20170718</span>/FiftyOneDegreesHashEngine.so
FiftyOneDegreesHashEngine.data_file=/<span style="background-color: #FFFF00">path to your file</span>/51Degrees-LiteV4.1.hash
</code>
</pre><p> is enough to set up the Hash extension with default configuration options.</p>
<p>NOTE: Make sure to check the highlighted parts. The first is dependent on the PHP version. This location will be printed when installing. The second is the path to where you have stored your 51Degrees data file.</p>
<h3>More Options</h3>
<div class="g-table g-table--overflow"><table class="c-table">
<tr class="c-table__row--heading">
<td class="c-table__cell">Option  </td><td class="c-table__cell">Type  </td><td class="c-table__cell">Description  </td><td class="c-table__cell">Default   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>required_properties</code>  </td><td class="c-table__cell"><code>string</code>  </td><td class="c-table__cell">List of properties which are required. Properties not in this list will not be returned.  </td><td class="c-table__cell"><code>""</code> (all properties)   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>performance_profile</code>  </td><td class="c-table__cell"><code>string</code>  </td><td class="c-table__cell">The performance profile to build the engine with. Available options are <code>"HighPerformance"</code>, <code>"MaxPerformance"</code>, <code>"Balanced"</code>, <code>"BalancedTemp"</code>, <code>"LowMemory"</code>, <code>"Default"</code>. (<code>NOTE</code>: Under environment where <code>PHP</code> processes are managed by a process manager such as with <code>Apache MPM</code> or <code>php-fpm</code>, Only <code>MaxPerformance</code> should be used. More details can be seen in <a href="#running-under-process-manager">Running Under Process Manager</a>.  </td><td class="c-table__cell"><code>"Default"</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>difference</code>  </td><td class="c-table__cell"><code>int</code>  </td><td class="c-table__cell">The difference value to allow when matching (<code>-1</code> to disable).  </td><td class="c-table__cell"><code>0</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>drift</code>  </td><td class="c-table__cell"><code>int</code>  </td><td class="c-table__cell">The drift to allow when matching (<code>-1</code> to disable).  </td><td class="c-table__cell"><code>0</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>use_predictive_graph</code>  </td><td class="c-table__cell"><code>string</code>  </td><td class="c-table__cell">True if the predictive optimized graph should be used for processing.  </td><td class="c-table__cell"><code>true</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>use_performance_graph</code>  </td><td class="c-table__cell"><code>string</code>  </td><td class="c-table__cell">True if the performance optimized graph should be used for processing.  </td><td class="c-table__cell"><code>false</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>concurrency</code>  </td><td class="c-table__cell"><code>int</code>  </td><td class="c-table__cell">Maximum number of potential concurrent threads that the engine will be used with. We recommend that this should not be set higher than the number of CPUs available on your machine and this should never be set to be less than or equal to 0. <code>NOTE</code>: If a value which is less than or equal to 0 is specified, default value will be used.  </td><td class="c-table__cell"><code>10</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>update_matched_useragent</code>  </td><td class="c-table__cell"><code>string</code>  </td><td class="c-table__cell">True if the detection should record the matched characters from the target User-Agent.  </td><td class="c-table__cell"><code>true</code>   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell"><code>max_matched_useragent_length</code>  </td><td class="c-table__cell"><code>int</code>  </td><td class="c-table__cell">Number of characters to consider in the matched User-Agent. Ignored if <code>update_matched_useragent</code> is false.  </td><td class="c-table__cell"><code>500</code>   </td></tr>
</table>
</div><h3>Running Under Process Manager</h3>
<p>When <code>PHP</code> program is run under a process manager such as <code>Apache MPM</code>, <code>php-fpm</code> or any other process manager, <code>MaxPerformance</code> profile must be specified for <code>performance_profile</code> option. <code>HighPerformance</code> can also be used but the performance cannot be compared to <code>MaxPerformance</code> profile.</p>
<p>The reason is that, in other profiles such as <code>Balanced</code>, <code>BalancedTemp</code>, <code>LowMemory</code> or <code>Default</code>, only a part of the data file is loaded into memory so from time to time, calls to read data from disk are required. This call use file handles from a file handle pool which was designed to optimise the performance. However, this pool was created when Device Detection engine module is loaded in the main process, so when process manager spawn child processes in response to incoming requests by forking the main process, this pool is copied to the child processes, causing the file handles to be shared. When multiple processes call to load data from file using shared file handles, problems could occur such as file position being changed unwantedly by other child processes. Thus, we recommend the <code>MaxPerformance</code> to be used as no call to data file is required.</p>
<p>While this is an issue in multi-processing environment, it is not a problem in multi-threading environment as the file handles are not shared and are managed by the file handle pool.</p>
<h4>Apache MPM</h4>
<p>When running under Apache MPM, only <code>prefork</code> mode is supported, since <code>dl()</code> call is required to load Device Detection engine module and it is not supported under multi-threading environment which <code>worker</code> and <code>event</code> mode does.</p>
<h4>Refresh Internal Data</h4>
<p>To reload the data file, <em>refreshData()</em> needs to be called as described in this <a href="https://51degrees.com/documentation/_examples__device_detection__data_file_updates__manual.html">example</a> . Thus, unless a reload is performed in the main process and all child processes, the data will not be updated. There is not a proven solution to do so yet, so we recommend a full server restart to be performed instead.</p>
<h2>Examples</h2>
<p>Before running the examples, the configuration for the native module MUST be added to the php.ini file. See <a href="#configuration">Configuration</a>.</p>
<p>To run the examples, you will need PHP and composer installed. Once these are available, install the dependencies required by the examples. Navigate to the repository root and execute:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">composer install</div></div><p>This will create the vendor directory containing autoload.php. Now navigate to the examples directory and start a PHP server with the relevant file. For example:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">php -S localhost:3000 gettingStartedWeb.php</div></div><p>This will start a local web server listening on port 3000. Open your web browser and browse to <a href="http://localhost:3000/">http://localhost:3000/</a> to see the example in action.</p>
<p>The table below describes the examples that are available.</p>
<div class="g-table g-table--overflow"><table class="c-table">
<tr class="c-table__row--heading">
<td class="c-table__cell">Example  </td><td class="c-table__cell">Description   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">gettingStartedConsole  </td><td class="c-table__cell">How to use the 51Degrees on-premise device detection API to determine details about a device based on its User-Agent and User-Agent Client Hints HTTP header values.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">gettingStartedWeb  </td><td class="c-table__cell">How to use the 51Degrees Cloud service to determine details about a device as part of a simple ASP.NET website.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">metadataConsole  </td><td class="c-table__cell">How to access the meta-data that relates to the device detection algorithm.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">manualDataUpdate  </td><td class="c-table__cell">How to update the device detection data file when a new one is available.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">matchMetrics  </td><td class="c-table__cell">Demonstrate the metrics that supply information such as confidence in the result.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">failureToMatch  </td><td class="c-table__cell">Demonstrates the functionality available when device detection is unable to identify the details of the device.   </td></tr>
<tr class="c-table__row">
<td class="c-table__cell">userAgentClientHints-Web  </td><td class="c-table__cell">Legacy example. Retained for the associated automated tests. See GettingStarted-Web instead.   </td></tr>
</table>
</div><h2>Tests</h2>
<h3>PHPUnit</h3>
<p>This repo has tests for the examples. To run the tests, make sure PHPUnit is installed then, in the root of this repo, call:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">phpunit --fail-on-warning --display-warnings --log-junit test-results.xml</div></div><h3>Performance</h3>
<p>Performance tests for the engine can be found in the <code>performance-tests</code> directory. To build this, the dependencies listed on <a href="https://github.com/51degrees/apachebench">ApacheBench</a> must be installed.</p>
<p>To build the tests, enter the <code>performance-tests</code> directory and run the following.</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">mkdir build</div><div class="c-code__line">cd build</div><div class="c-code__line">cmake ..</div><div class="c-code__line">cmake --build .</div></div><p>Once the build is completed, ensure that the <code>php.ini</code> file is correctly configured, and run the tests from the build directory with:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">./runPerf.sh</div></div><p>This will give two output files: <code>calibrate.out</code> and <code>process.out</code>. These detail the performance for a calibration page where there is no pipeline processing, and for a page which processes the request through a pipeline containing the device detection on-premise engine, and fetches properties.</p>
<h2>Development</h2>
<p>When making changes to this repository, it may be necessary to link to a local development version of pipeline dependencies. For information on this, see <a href="https://getcomposer.org/doc/05-repositories.md#path">Composer local path</a>.</p>
<p>For exmaple, if a development version of <code>51degrees/fiftyone.pipeline.core</code> was stored locally, the location would be added with:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">&quot;repositories&quot;: [</div><div class="c-code__line">    {</div><div class="c-code__line">        &quot;type&quot;: &quot;path&quot;,</div><div class="c-code__line">        &quot;url&quot;: &quot;../../path/to/packages/pipeline-php-core&quot;</div><div class="c-code__line">    }</div><div class="c-code__line">]</div></div><p>then the dependency changed to:</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line">&quot;51degrees/fiftyone.pipeline.core&quot;: &quot;*&quot;</div></div> </section></div><!-- PageDoc -->
</div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
